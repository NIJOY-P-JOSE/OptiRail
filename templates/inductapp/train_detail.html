{% extends 'base.html' %}

{% block title %}{{ train.train_name }} - Train Details{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Train Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'ranklist' %}">Ranklist</a></li>
                    <li class="breadcrumb-item active">{{ train.train_number }}</li>
                </ol>
            </nav>
            
            <div class="train-header">
                <div class="d-flex align-items-center">
                    <div class="train-icon me-3">
                        <i class="bi bi-train-lightrail-front"></i>
                    </div>
                    <div>
                        <h1 class="display-6 mb-1">{{ train.train_number }}</h1>
                        <h2 class="h4 text-muted mb-2">{{ train.train_name }}</h2>
                        <span class="badge bg-{{ train.status }} fs-6">
                            {% if train.status == 'ok' %}
                                <i class="bi bi-check-circle me-1"></i>Ready for Service
                            {% elif train.status == 'minor_maintenance' %}
                                <i class="bi bi-exclamation-triangle me-1"></i>Minor Maintenance
                            {% else %}
                                <i class="bi bi-x-circle me-1"></i>Cannot Schedule
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="rank-display">
                    <span class="rank-number">#{{ train.rank }}</span>
                    <small class="text-muted">Current Rank</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Train Details Grid -->
    <div class="row">
        <!-- Basic Information -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Basic Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-group">
                                <label>Current Mileage</label>
                                <div class="editable-field" data-field="current_mileage">
                                    <span class="field-value">{{ train.current_mileage|floatformat:0 }} km</span>
                                    {% if 'current_mileage' in can_edit or '*' in can_edit %}
                                    <button class="btn btn-sm btn-outline-primary edit-btn">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label>Current Location</label>
                                <div class="editable-field" data-field="current_stabling_bay">
                                    <span class="field-value">{{ train.current_stabling_bay }}</span>
                                    {% if 'current_stabling_bay' in can_edit or '*' in can_edit %}
                                    <button class="btn btn-sm btn-outline-primary edit-btn">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label>Last Service Date</label>
                                <div class="field-value">{{ train.last_service_date }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label>Status Notes</label>
                                <div class="editable-field" data-field="status_notes">
                                    <span class="field-value">{{ train.status_notes }}</span>
                                    {% if 'status_notes' in can_edit or '*' in can_edit %}
                                    <button class="btn btn-sm btn-outline-primary edit-btn">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Maintenance Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-tools me-2"></i>
                        Maintenance & Cleaning
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-group">
                                <label>Cleaning Status</label>
                                <div class="editable-field" data-field="cleaning_status">
                                    <span class="field-value">
                                        <span class="badge {% if 'clean' in train.cleaning_status.lower %}bg-success{% else %}bg-warning{% endif %}">
                                            {{ train.cleaning_status }}
                                        </span>
                                    </span>
                                    {% if 'cleaning_status' in can_edit or '*' in can_edit %}
                                    <button class="btn btn-sm btn-outline-primary edit-btn">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="info-group">
                                <label>Maintenance Notes</label>
                                <div class="editable-field" data-field="maintenance_notes">
                                    <span class="field-value">{{ train.maintenance_notes|default:"No maintenance notes" }}</span>
                                    {% if 'maintenance_notes' in can_edit or '*' in can_edit %}
                                    <button class="btn btn-sm btn-outline-primary edit-btn">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="info-group">
                                <label>Cleaning Notes</label>
                                <div class="editable-field" data-field="cleaning_notes">
                                    <span class="field-value">{{ train.cleaning_notes|default:"No cleaning notes" }}</span>
                                    {% if 'cleaning_notes' in can_edit or '*' in can_edit %}
                                    <button class="btn btn-sm btn-outline-primary edit-btn">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Job Cards -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-check me-2"></i>
                        Job Cards
                    </h5>
                </div>
                <div class="card-body">
                    {% for job_card in job_cards %}
                    <div class="job-card-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ job_card.title }}</h6>
                                <span class="badge bg-{{ job_card.status }}">{{ job_card.status|title }}</span>
                                <span class="badge bg-{{ job_card.priority }} ms-1">{{ job_card.priority|title }} Priority</span>
                            </div>
                            {% if 'job_cards' in can_edit or '*' in can_edit %}
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No job cards assigned</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Certificate Upload -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        Certificates
                    </h5>
                </div>
                <div class="card-body">
                    {% if 'certificates' in can_edit or '*' in can_edit %}
                    <div class="upload-zone mb-3">
                        <input type="file" id="certificate-upload" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                        <div class="upload-help">
                            <i class="bi bi-cloud-upload"></i>
                            <p>Upload certificates (PDF, JPG, PNG)</p>
                        </div>
                    </div>
                    <button id="verify-certificate" class="btn btn-metro-accent w-100 mb-3" disabled>
                        <i class="bi bi-robot me-2"></i>
                        Verify with AI
                    </button>
                    {% endif %}
                    
                    <div class="certificate-list">
                        {% for cert in certificates %}
                        <div class="certificate-item">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                                <div class="flex-grow-1">
                                    <div class="cert-name">{{ cert.name }}</div>
                                    <small class="text-muted">{{ cert.upload_date }}</small>
                                </div>
                                {% if cert.is_verified %}
                                <i class="bi bi-check-circle text-success"></i>
                                {% else %}
                                <i class="bi bi-exclamation-circle text-warning"></i>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted">No certificates uploaded</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary">
                            <i class="bi bi-printer me-2"></i>
                            Print Summary
                        </button>
                        <button class="btn btn-outline-success">
                            <i class="bi bi-download me-2"></i>
                            Export Data
                        </button>
                        {% if '*' in can_edit %}
                        <button class="btn btn-outline-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Mark Critical
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Certificate Verification Modal -->
<div class="modal fade" id="verificationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-robot me-2"></i>
                    AI Certificate Verification
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="verification-content">
                    <div class="col-md-6">
                        <h6>Original Document</h6>
                        <div id="document-preview"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Extracted Information</h6>
                        <div id="extracted-data"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="approve-verification">
                    <i class="bi bi-check-circle me-2"></i>
                    Approve
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Certificate upload and verification
document.getElementById('certificate-upload')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById('verify-certificate').disabled = false;
    }
});

document.getElementById('verify-certificate')?.addEventListener('click', function() {
    const fileInput = document.getElementById('certificate-upload');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a certificate file first');
        return;
    }
    
    const formData = new FormData();
    formData.append('certificate', file);
    
    // Show loading state
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
    
    fetch('/api/extract_certificate/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showVerificationModal(file, data.extracted_data);
        } else {
            alert('Failed to process certificate');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing certificate');
    })
    .finally(() => {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-robot me-2"></i>Verify with AI';
    });
});

function showVerificationModal(file, extractedData) {
    // Show document preview
    const documentPreview = document.getElementById('document-preview');
    if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.className = 'img-fluid';
        documentPreview.innerHTML = '';
        documentPreview.appendChild(img);
    } else {
        documentPreview.innerHTML = `
            <div class="text-center p-4">
                <i class="bi bi-file-earmark-pdf display-4 text-danger"></i>
                <p class="mt-2">${file.name}</p>
            </div>
        `;
    }
    
    // Show extracted data
    const extractedDataDiv = document.getElementById('extracted-data');
    extractedDataDiv.innerHTML = `
        <div class="extracted-fields">
            <div class="field-group">
                <label>Certificate Type:</label>
                <span>${extractedData.certificate_type}</span>
            </div>
            <div class="field-group">
                <label>Certificate Number:</label>
                <span>${extractedData.certificate_number}</span>
            </div>
            <div class="field-group">
                <label>Issue Date:</label>
                <span>${extractedData.issue_date}</span>
            </div>
            <div class="field-group">
                <label>Expiry Date:</label>
                <span>${extractedData.expiry_date}</span>
            </div>
            <div class="field-group">
                <label>Issuing Authority:</label>
                <span>${extractedData.issuing_authority}</span>
            </div>
            <div class="confidence-score">
                <small class="text-muted">
                    Confidence: ${(extractedData.confidence_score || 0.95) * 100}%
                </small>
            </div>
        </div>
    `;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('verificationModal'));
    modal.show();
}

// Editable fields functionality
document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const fieldContainer = this.closest('.editable-field');
        const fieldName = fieldContainer.dataset.field;
        const valueSpan = fieldContainer.querySelector('.field-value');
        const currentValue = valueSpan.textContent.trim();
        
        // Create input field
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control form-control-sm';
        input.value = currentValue;
        
        // Replace content
        valueSpan.style.display = 'none';
        this.style.display = 'none';
        fieldContainer.appendChild(input);
        
        // Add save/cancel buttons
        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'btn-group btn-group-sm mt-1';
        buttonGroup.innerHTML = `
            <button type="button" class="btn btn-success save-btn">
                <i class="bi bi-check"></i>
            </button>
            <button type="button" class="btn btn-secondary cancel-btn">
                <i class="bi bi-x"></i>
            </button>
        `;
        fieldContainer.appendChild(buttonGroup);
        
        input.focus();
        
        // Save functionality
        buttonGroup.querySelector('.save-btn').addEventListener('click', () => {
            saveField(fieldName, input.value, fieldContainer, valueSpan, this);
        });
        
        // Cancel functionality
        buttonGroup.querySelector('.cancel-btn').addEventListener('click', () => {
            cancelEdit(fieldContainer, valueSpan, this);
        });
        
        // Enter key to save
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveField(fieldName, input.value, fieldContainer, valueSpan, this);
            }
        });
    });
});

function saveField(fieldName, newValue, container, valueSpan, editBtn) {
    // Here you would make an AJAX call to save the data
    // For now, just update the display
    valueSpan.textContent = newValue;
    cancelEdit(container, valueSpan, editBtn);
    
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        Field updated successfully!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 3000);
}

function cancelEdit(container, valueSpan, editBtn) {
    // Remove input and buttons
    const input = container.querySelector('input');
    const buttonGroup = container.querySelector('.btn-group');
    
    if (input) input.remove();
    if (buttonGroup) buttonGroup.remove();
    
    // Show original elements
    valueSpan.style.display = '';
    editBtn.style.display = '';
}
</script>
{% endblock %}